container_commands:
  00_remove_stray_db:
    command: |
      # remove any stray db in the project root
      rm -f /var/app/current/db.sqlite3 || true
    leader_only: true

  01_create_data_dir:
    command: |
      sudo mkdir -p /var/app/data
      sudo chown -R webapp:webapp /var/app/data
      sudo chmod 775 /var/app/data
    leader_only: true

  02_migrate:
    command: |
      source /var/app/venv/*/bin/activate
      cd /var/app/current
      # Set the env var for persistent DB
      export SQLITE_PATH=/var/app/data/db.sqlite3
      python manage.py migrate --noinput
    leader_only: true

  03_seed_polls:
    command: |
      source /var/app/venv/*/bin/activate
      cd /var/app/current
      export SQLITE_PATH=/var/app/data/db.sqlite3
      python - <<PY
import os, django
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "SEassignment1.settings")  # replace with your project name
django.setup()
from django.utils import timezone
from polls.models import Question, Choice

# First question
q1, _ = Question.objects.get_or_create(
    question_text="Which framework do you like most?",
    defaults={"pub_date": timezone.now()}
)
Choice.objects.get_or_create(question=q1, choice_text="Django", defaults={"votes": 0})
Choice.objects.get_or_create(question=q1, choice_text="Flask", defaults={"votes": 0})
Choice.objects.get_or_create(question=q1, choice_text="FastAPI", defaults={"votes": 0})

# Second question
q2, _ = Question.objects.get_or_create(
    question_text="Whatâ€™s your favorite programming language?",
    defaults={"pub_date": timezone.now()}
)
Choice.objects.get_or_create(question=q2, choice_text="Python", defaults={"votes": 0})
Choice.objects.get_or_create(question=q2, choice_text="Java", defaults={"votes": 0})
Choice.objects.get_or_create(question=q2, choice_text="JavaScript", defaults={"votes": 0})
PY
    leader_only: true
